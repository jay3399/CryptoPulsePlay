<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
</head>
<body>

<div id="loginPage">
<h1>Login / Sign Up</h1>
<input id="emailInput" type="email" placeholder="Enter your email">
<button id="submitButton">Submit</button>
<p id="message"></p>
<button id="verifyButton" style="display:none;">Verify Email</button>
</div>

<div id="mainPage" style="display:none;">
  <h1>환영합니다</h1>
</div>

<script>


  document.addEventListener("DOMContentLoaded",async () => {
    const emailInput = document.getElementById("emailInput");
    const submitButton = document.getElementById("submitButton");
    const messageElement = document.getElementById("message");
    const verifyButton = document.getElementById("verifyButton");
    const loginPage = document.getElementById("loginPage");
    const mainPage = document.getElementById("mainPage");




    let jwtToken = localStorage.getItem("loginToken");

    if (jwtToken) {
      try {
        const response = await fetch(`/verifyLoginToken?token=${jwtToken}`, {
          method: "GET",
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          }
        });
        // const data = await response.json();

        if (response.ok) {
          loginPage.style.display = "none";
          mainPage.style.display = "block";
        } else {
          alert("유효하지 않은 토큰입니다.");
          localStorage.removeItem("loginToken");
          loginPage.style.display = "block";
          mainPage.style.display = "none";
        }
      } catch (error) {
        console.log("error");
      }
    } else {
      loginPage.style.display = "block";
      mainPage.style.display = "none";
    }


    submitButton.addEventListener("click", async () => {
      const email = emailInput.value;
      console.log(email);
      const deviceInfo = "your-device-info-here";


      try {
        const response = await fetch("/signIn", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "DeviceInfo": deviceInfo,
          },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        console.log(data);

        if (data.message) {
          messageElement.textContent = data.message;
          verifyButton.style.display = "block";

        } else {
          jwtToken = data.loginToken;
          localStorage.setItem('loginToken', jwtToken);

        }
      } catch (error) {
        console.log("error");
      }
    });

    verifyButton.addEventListener("click", async () => {

      const storedToken = localStorage.getItem("loginToken");

      if(!storedToken){
        alert("이메일 인증을 완료해주세요");
        return;
      }

      try {
        const response = await fetch(`/verifyLoginToken?token=${storedToken}`, {
          method: "GET",
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          }
        });

        if (response.ok) {
          console.log("complete")
          loginPage.style.display = "none";
          mainPage.style.display = "block";

        } else {
          alert("권한이 없습니다.");
          loginPage.style.display = "block";
          mainPage.style.display = "none";
        }
      } catch (error) {
        console.log("error");
      }
    });
  });



</script>
</body>
</html>